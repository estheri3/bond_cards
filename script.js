const questions = {
  connect: [
    {
      q: "나와 하나님을 이어주는 매듭 같은 순간은 언제였나요?",
      verse: "높음이나 깊음이나 다른 아무 피조물이라도 우리를 우리 주 그리스도 예수 안에 있는 하나님의 사랑에서 끊을 수 없으리라 (로마서 8:39)"
    },
    {
      q: "나를 지탱해주는 '세겹줄 같은 관계'는 누구인가요?",
      verse: "세 겹 줄은 쉽게 끊어지지 아니하느니라(전도서 4:12b)"
    },
    {
      q: "신앙적인 고민을 솔직하게, 깊게 나누는 관계가 있나요? 있다면 누구인가요?",
      verse: "서로 돌아보아 사랑과 선행을 격려하며 (히브리서 10:24)"
    },
    {
      q: "공동체 안에서 서로 묶여 있다는 것을 느낀 경험은 언제였나요?",
      verse: "이 모든 것 위에 사랑을 더하라 이는 온전하게 매는 띠니라 (골로새서 3:14)"
    },
    {
      q: "내가 의지하고 기도하는 끊어지지 않는 세겹줄의 동역자가 있나요?",
      verse: "한 사람이면 패하겠거니와 두 사람이면 맞설 수 있나니 세 겹 줄은 쉽게 끊어지지 아니하느니라(전도서 4:12)"
    },
    {
      q: "지금 나를 가장 붙잡아 주는 끈(사람, 신앙, 취미 등)은 무엇인가요?",
      verse: ""
    },
    {
      q: "우리의 매듭은 사랑으로 묶여져 단단해지길 원합니다. 이번 학기, 내가 사랑으로 묶고 싶은 관계는 무엇인가요?",
      verse: "새 계명을 너희에게 주노니 서로 사랑하라 내가 너희를 사랑한 것 같이 너희도 서로 사랑하라 (요한복음 13:34)"
    },
    {
      q: "학교에서 제일 좋아하는 장소, 또는 자주 가는 장소는 어디인가요?",
      verse: ""
    },
    {
      q: "매듭을 묶을 때처럼 어떤 일은 시간과 정성이 필요합니다. 지금 어떤 일에 시간과 정성을 쏟고 있나요? 그 과정을 통해 배우고 있는 건 무엇인가요?",
      verse: ""
    },
    {
      q: "매듭을 묶을 때 힘이 필요하듯, 나의 시작을 주님께 맡기며 붙잡고 싶은 기도제목이 무엇인가요?",
      verse: "너희 염려를 다 주께 맡기라 이는 그가 너희를 돌보심이라 (베드로전서 5:7)"
    },
    {
      q: "앞으로 대학 생활에서 새롭게 묶고 싶은 매듭(새로운 관계, 새로운 도전)은 무엇인가요?",
      verse: ""
    }
  ],

  bind: [
    {
      q: "하나님과의 매듭이 느슨해진 것 같다고 느꼈던 순간은 언제였나요?",
      verse: "너희는 가까이 하라 그리하면 너희를 가까이 하시리라 (야고보서 4:8a)"
    },
    {
      q: "지금 내 삶에서 풀고 싶은 '매듭' 같은 고민이나 과제가 있다면?",
      verse: ""
    },
    {
      q: "내가 매듭지어 정리해야 할 습관은 무엇인가요? (게으름, 미루기, 누군가를 향한 미움, 비교의식 등등)",
      verse: ""
    },
    {
      q: "나와 하나님 사이의 관계는 지금 단단히 묶여 있는지, 혹은 느슨하게 묶여 있는지 표현해본다면 어떤가요?",
      verse: ""
    },
    {
      q: "놓지 못하는 매듭(죄악)이 있나요?",
      verse: "거짓으로 끈을 삼아 죄악을 끌며 수레 줄로 함 같이 죄악을 끄는 자는 화 있을진저 (이사야 5:18)"
    },
    {
      q: "내 마음을 꽉 묶고 있는 근심은 무엇인가요?",
      verse: "아무 것도 염려하지 말고 오직 모든 일에 기도와 간구로 너희 구할 것을 감사함으로 하나님께 아뢰라 (빌립보서 4:6)"
    },
    {
      q: "죄의 습관이라는 매듭이 나를 얽매고 있다고 느낀 순간이 있나요?",
      verse: "너희가 죄의 종이 되었을 때에는 의에 대하여 자유하였느니라 (로마서 6:20)"
    },
    {
      q: "학업, 진로, 대인관계 중 지금 가장 엉켜 있는 매듭은 어디에 있나요?",
      verse: "사람이 마음으로 자기의 길을 계획할지라도 그의 걸음을 인도하시는 이는 여호와시니라 (잠언 16:9)"
    },
    {
      q: "매듭은 단단히 묶어야 할 때도 있고, 풀어야 할 때도 있잖아요. 내 삶에서 하나님께 맡겨드리고 싶은 풀어야 하는 매듭은 무엇인가요?",
      verse: "수고하고 무거운 짐진 자들아 다 내게로 오라 내가 너희를 쉬게 하리라 (마태복음 11:28)"
    }
  ],

  free: [
    {
      q: "하나님과의 관계가 매듭처럼 단단히 묶여있다고 느낀 순간은 언제인가요?",
      verse: "여호와는 나의 힘이요 나의 방패시니 (시편 28:7)"
    },
    {
      q: "나의 삶에서 끊어지지 않고 이어져야 할 신앙의 습관은 무엇인가요?",
      verse: "항상 기뻐하라, 쉬지 말고 기도하라, 범사에 감사하라 (데살로니가전서 5:16-18a)"
    },
    {
      q: "나에게 힘이 되는 성경 말씀, 또는 찬양을 이야기해주세요",
      verse: ""
    },
    {
      q: "하나님께서 매듭을 풀어주신 경험이 있나요?",
      verse: "그러므로 아들이 너희를 자유케 하면 너희가 참으로 자유하리라 (요한복음 8:36)"
    },
    {
      q: "예수님께서 '결박을 풀어 자유케 한다'는 말씀을 경험한 적 있나요?",
      verse: "진리를 알지니 진리가 너희를 자유롭게 하리라 (요한복음 8:32)"
    },
    {
      q: "용서를 통해 풀렸던 관계의 매듭이 있나요?",
      verse: "서로 인자하게 하며 불쌍히 여기며 서로 용서하기를 하나님이 그리스도 안에서 너희를 용서하심과 같이 하라 (에베소서 4:32)"
    },
    {
      q: "엉킨 매듭처럼 예상치 못하게 문제가 꼬였던 적이 있나요? 그때 어떻게 풀어갔나요?",
      verse: ""
    },
    {
      q: "이번 분기 캠퍼스모임을 통해 단단하게 만들고 싶은 ‘매듭’은 어떤 모습인가요?",
      verse: ""
    },
    {
      q: "새로운 시작 앞에서 마음을 단단히 묶어주는 습관이나 태도는 무엇인가요?",
      verse: "믿음의 주요 또 온전케 하시는 이인 예수를 바라보자 (히브리서 12:2)"
    }
  ]
};

const lastPicked = { connect: null, bind: null, free: null };

// 섹션 전환
function nextSection(id) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if (id.includes('section1')) hideBtns('retry1','next1');
  if (id.includes('section2')) hideBtns('retry2','next2');
  if (id.includes('section3')) hideBtns('retry3','next3');
}

// 카드 플립
function enableCardFlip(cardId, boxId, category, retryId, nextId) {
  const cardElement = document.getElementById(cardId);

  const flipHandler = () => {
    if (cardElement.classList.contains("is-flipped")) return;

    drawQuestion(boxId, category);
    cardElement.classList.add("is-flipped");

    if (!cardElement.dataset.retried) {
      document.getElementById(retryId).style.display = "inline-block";
      document.getElementById(nextId).style.display = "none";
    } else {
      document.getElementById(retryId).style.display = "none";
      document.getElementById(nextId).style.display = "inline-block";
      cardElement.dataset.retried = "";
    }
  };

  cardElement.addEventListener("click", flipHandler);
  cardElement.addEventListener("touchstart", flipHandler);
}

// 질문 뽑기
function drawQuestion(boxId, category) {
  const box = document.getElementById(boxId);
  const qlist = questions[category];

  let randomIndex;
  do {
    randomIndex = Math.floor(Math.random() * qlist.length);
  } while (randomIndex === lastPicked[category] && qlist.length > 1);

  lastPicked[category] = randomIndex;
  const qobj = qlist[randomIndex];

  const verseHtml = qobj.verse && qobj.verse.trim() !== "" 
    ? `<h3>Verse</h3><p>${qobj.verse}</p>` 
    : "";

  box.innerHTML = `
    <h3>Question</h3>
    <p>${qobj.q}</p>
    ${verseHtml}
  `;
}

// 다시 뽑기
function retry(boxId, category, retryId, nextId) {
  const cardElement = document.getElementById(boxId).closest(".card");
  cardElement.classList.remove("is-flipped");

  const qlist = questions[category];
  let randomIndex;
  do {
    randomIndex = Math.floor(Math.random() * qlist.length);
  } while (randomIndex === lastPicked[category] && qlist.length > 1);

  lastPicked[category] = randomIndex;
  const qobj = qlist[randomIndex];

  const verseHtml = qobj.verse && qobj.verse.trim() !== "" 
    ? `<h3>Verse</h3><p>${qobj.verse}</p>` 
    : "";

  document.getElementById(boxId).innerHTML = `
    <h3>Question</h3>
    <p>${qobj.q}</p>
    ${verseHtml}
  `;

  cardElement.dataset.retried = "true";

  document.getElementById(retryId).style.display = "none";
  document.getElementById(nextId).style.display = "none";
}

// 버튼 숨기기
function hideBtns(retryId, nextId) {
  document.getElementById(retryId).style.display = "none";
  document.getElementById(nextId).style.display = "none";
}

// 전체 리셋
function resetAll() {
  document.querySelectorAll('.card').forEach(card => {
    card.classList.remove("is-flipped");
    card.removeAttribute("data-retried");
  });

  document.querySelectorAll('.question-box').forEach(box => {
    box.innerHTML = "";
  });

  document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.style.display = "none";
  });

  lastPicked.connect = null;
  lastPicked.bind = null;
  lastPicked.free = null;

  nextSection('intro');
}

// 초기화
document.addEventListener("DOMContentLoaded", () => {
  enableCardFlip("card1", "q1", "connect", "retry1", "next1");
  enableCardFlip("card2", "q2", "bind", "retry2", "next2");
  enableCardFlip("card3", "q3", "free", "retry3", "next3");
});
